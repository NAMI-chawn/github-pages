jobs:
  build-and-push-image:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - dockerfile: ./web/Dockerfile
            image: ghcr.io/user/redwood-docker-compose-web
            appname: web
          - dockerfile: ./api/Dockerfile
            image: ghcr.io/user/redwood-docker-compose-api
            appname: api

    permissions:
      contents: read
      packages: write

    steps:
      - name: Get branch name
        id: branch-name
        uses: tj-actions/branch-names@v6
      # .... do a lot of stuf
      - name: Deploy image
        uses: floms/action-caprover@v1
        with:
          host: '${{ secrets.CAPROVER_SERVER }}'
          password: '${{ secrets.CAPROVER_PASSWORD }}'
          app: join(${{ id }}${{ matrix.appname }})
          image: ${{ steps.meta.outputs.tags }}
